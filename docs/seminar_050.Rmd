---
title: 'Семинар 5. Множественная регрессия'
date: 'Июнь, 14, 2018'
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: yes
lang: ru-RU
editor_options:
  chunk_output_type: console
---

---
title: 'Семинар 5. Множественная регрессия'
date: 'Июнь, 14, 2018'
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: yes
lang: ru-RU
editor_options:
  chunk_output_type: console
---

```{r}
library(tidyverse) # обработка данных, графики...
library(skimr) # описательные статистики
library(rio) # импорт фантастического количества форматов данных
library(broom) # метла превращает результаты оценивания моделей в таблички
library(GGally)
library(sjPlot)
library(lmtest)
```

Возьмём набор данных об изменении пульса студентов до и после упражнений.
Его описание доступно по [ссылке](http://www.statsci.org/data/oz/ms212.html).

Загрузим данные и посмотрим на описательные статистики.

```{r}
pulse <- import('pulse.txt')
skim(pulse)
glimpse(pulse)
```

- Сколько в данных наблюдений? Сколько переменных?
- Какие переменные на самом деле являются факторными?

Вернём факторным переменным положенный статус!

```{r}
pulse_fct <- pulse %>%
  mutate_at(vars(-Weight, -Height, -Age, -Pulse1, -Pulse2), factor)
```

И теперь можно приступать к регрессиям.
Начнём с парной и построим регрессию пульса после упражнений `Pulse2` на константу и пульс до упражнений `Pulse1`.
Для этого воспользуемся командой `lm()` и передадим ей данные и формулу.

```{r}
model_r <- lm(data = pulse_fct, Pulse2 ~ Pulse1)
```

С помощью команды `summary()` посмотрим на описание модели.

```{r}
summary(model_r)
```

TODO: вопросы

Другой способ посмотреть на описание модели — воспользоваться функциями пакета `broom`.
Оценки коэффциентов, стандартные ошибки, p-значения выводит команда `tidy()`,
а `glance()` покажет общие характеристики модели, для которых достаточно одной строчки, — коэффциент детерминации, значение лог-функции правдоподобия, AIC, BIC...

```{r}
tidy(model_r)
glance(model_r)
```

Если из общей таблицы описания модели нужна только информация о коэффициентах, то поможет команда `coeftest()` из пакета `lmtest()`.

```{r}
coeftest(model_r)
```

Нарисуем линию регрессии для модели, в которой зависимая переменная — это пульс после упражнений, а объясняющая — пульс до упражнений.
Для этого к диаграмме рассеяния добавим дополнительный слой `geom_smooth()`.
Внутри него за линейную регрессию отвечает `method = 'lm'`.

```{r}
ggplot(data = pulse_fct, aes(x = Pulse1, y = Pulse2)) +
  geom_point() +
  geom_smooth(method = 'lm')
```

Теперь оценим более сложную модель.
К объясняющим переменным добавим вес студента `Weight` и бинарные переменные `Ran`, где 2 соответствует студенту, который выполнял упражнения , и `Smokes`, где значение 2 — это студент-курильщик.

```{r}
model_ur <- lm(data = pulse_fct, Pulse2 ~ Weight + Pulse1 + Ran + Smokes)
summary(model_ur)
```



```{r}
ggnostic(model = model_ur)
```

Построим 5%-ые доверительные интервалы для всех коэффициентов модели `model_ur`.
Для этого будем использовать команду `confint()`.
Поменять уровень значимости можно аргументом `level`.
Затем визуилизируем получившиеся доверительные интервалы командой ??? из пакета ???.

```{r}
confint(model_ur)
# TODO: какую из этих взять?
sjp.lm(model_ur)
ggcoef(model_ur)
```


```{r}
import('Dataset.data')
```
