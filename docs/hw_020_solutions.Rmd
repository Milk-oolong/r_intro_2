---
title: 'Домашнее задание 2'
date: 'May 27, 2018'
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: yes
lang: ru-RU
editor_options:
  chunk_output_type: console
---

Во второй домашке узнаем всё про пассажиров Титаника и закрепим изученное на семинаре :)

Прежде всего — библиотеки!

* **Упражнение 0.**

Отключите в этом куске кода сообщения и предупреждения.

```{r, message=FALSE, warning=FALSE}
library(tidyverse) # обработка данных, графики...
library(vcd) # мозаичные графики для качественных переменных
library(skimr) # описательные статистики
library(rio) # импорт фантастического количества форматов данных
library(ggalluvial) # потоковые диаграммы для качественных переменных
library(titanic) # набор данных о пассажирах Титаника
library(corrplot) # визуализация корреляций
library(reshape2) # длинные и широкие таблицы
```

Описание данных:

- Survived - выжил ли пассажир (1 — да, 0 — нет)

- Pclass - класс билета (1 — первый, 2 — второй, 3 — третий)

- Name - имя пассажира

- Sex - пол пассажира

- Age - возраст пассажира

- SibSp - число братьев или сестер / присутствие мужа или жены на корабле

- Parch - количество детей / родителей на корабле

- Ticket - номер билета

- Fare - стоимость билета

- Cabin - номер каюты

- Embarked - порт посадки (C = Cherbourg, Q = Queenstown, S = Southampton)

Прежде всего положим данные в переменную `df` и посмотрим описателные статистики.

```{r}
df <- import('titanic.csv')
skim(df)
```

- Сколько наблюдений в данных?

- Сколько переменных?

- Все ли переменные соответсвуют своему типу по смыслу?

* **Упражнение 1.**

Пассажиры Титаника могли попасть на корабаль из трёх портов, два из которых находились в Великобритании, а один во Франции. 

- Какова частотность каждой категории в столбце `Embarked`? 

- Объедините британские порты Саутгемптон и Квинстаун в одну категорию `GB` и сохраните результат в переменной df2.

- Что стало с частотностью категорий `Embarked` в новой таблице `df2`

```{r}
table(df$Embarked)
df2 <- mutate(df, Embarked = fct_collapse(Embarked, GB = c('Q', 'C')))
table(df2$Embarked)
```


* **Упражнение 2.**

Выясним, как связаны класс каюты пассажира и выживание. 

- Составьте таблицу сопряжённости признаков `PClass` и `Survived`.

- Проведите тест на независимость этих признаков.

- Какой вывод можно сделать?

```{r}
ctable <- table(df$Pclass, df$Survived)
chisq.test(ctable)
```

* **Упражнение 3.**

Посмотрим, как соотносятся пол пассажира и класс каюты с его выживанием.

- Составьте таблицу сопряжённости для признаков `Pclass`, `Survived`, `Sex` и сохраните её. Не забудьте добавить названия! За это отвечает аргумент `dnn` :)

- Постройте мозаичный график для получившейся таблицы, обязателно цветной и с легендой!

- Что на нём изображено?

```{r}
ctable <- table(df$Pclass, df$Survived, df$Sex, dnn = c('Pclass', 'Survived', 'Sex'))
mosaic(ctable, shade = TRUE, legend = TRUE)
```

* **Упражнение 4.**

Продолжим исследовать информацию о пассажирах!

- Посчитайте корреляции признаков `Survived`, `Age`, `SibSp`, `Parch`, `Fare`.

- Какой признак сильнее всего коррелирует с выживанием?

- Визуализируйте корреляции: постройте график со значениями выше диагонали и квадратами внутри.

- Для чего понадобился аргумент `use = 'pairwise.complete.obs'`?

```{r}
mcor <- cor(df[, c('Survived', 'Age', 'SibSp', 'Parch', 'Fare')], use = 'pairwise.complete.obs')
mcor
corrplot(mcor, method = 'square', type = 'upper')
```

* **Упражнение 5.**

Посмотрим на распределение возраста пассажиров Титаника.

- Постройте скрипичный график командой `geom_viloin()` из пакета `ggplot2`. Не забудьте подписать оси и придумать название!

- Разбейте график на две панели по признаку `Survived`.

```{r}
df <- mutate(df, Pclass = factor(Pclass))

ggplot(data = df, aes(x = Pclass, y = Age)) +
  geom_violin() + 
  labs(x = 'Класс каюты', y = 'Возраст', title = 'Возраст пассажиров')

ggplot(data = df, aes(x = factor(Pclass), y = Age)) +
  geom_violin() + 
  facet_grid(Survived ~ .) +
  labs(x = 'Класс каюты', y = 'Возраст', title = 'Возраст пассажиров')
```

* **Упражнение 6.**

Цель задания — построить потоковую диаграмму!

- Посчитайте таблицу частот по переменным `Pclass`, `Sex`, `Survived`. Для этого сгруппируйте наблюдения по этим переменным, а затем для каждой группы посчитайте количество наблюдений `n()`.

- Дополните код для потоковой диаграммы. В качестве аргумента `data` нужно указать созданную таблицу частот, в аргументы `axis_` передайте класс каюты, пол и выживыших в этом порядке. Аргумент `fill` отвечает за цвет потоков — раскрасьте их по классу каюты.

```{r}
freq_table <- group_by(df, Pclass, Sex, Survived) %>% summarise(freq = n())
freq_table

ggplot(data = freq_table, aes(weight = freq, axis1 = Pclass, axis2 = Sex, axis3 = Survived)) + 
  geom_alluvium(aes(fill = Pclass), width = 1/12) +
  geom_stratum(width = 1/8) +
  geom_label(stat = 'stratum', label.strata = TRUE) +
  scale_x_continuous(breaks = 1:3, labels = c('Class', 'Sex', 'Survived')) 
```

* **Упражнение 7.**

Постройте широкую таблицу, в которой по строкам будем класс каюты пассажира, по столбцам — количесвто его братьев и сестёр на корабле, а внутри — средняя цена билета. 

```{r}
dcast(df, SibSp ~ Pclass, value.var = 'Fare', fun.aggregate = mean)
```

* **Упражнение 8.**

В вашем распоряжении новые (но недостоверные) данные о пассажирах Титаника. 

- Загрузите их из файла `titanic_info.xlsx`.
- Сколько наблюдений в новых данных? Какие переменные совпадают с основными данными?
- Объедините новую таблицу с таблицей `df` всеми возможными способами. 
- Для каждого случая определите колчиство наблюдений в получившейся таблице.

```{r}
new_df <- import('titanic_info.xlsx')

lj <- left_join(df, new_df, by = 'PassengerId')
skim(lj)

rj <- right_join(df, new_df, by = 'PassengerId')
skim(rj)

ij <- inner_join(df, new_df, by = 'PassengerId')
skim(ij)

fj <- full_join(df, new_df, by = 'PassengerId')
skim(fj)
```


Бонус победителю!

Если все упражнения получились, можно смело нажимать `Knit` :)
